let modelData = []; // Initialize empty array
const viewer = document.querySelector('#main-viewer');
const modelSelect = document.querySelector('#model-select');

// 1. Fetch data from the external JSON file
async function loadModelData() {
    try {
        const response = await fetch('models.json');
        modelData = await response.json();
        initializeApp();
    } catch (error) {
        console.error("Error loading models.json:", error);
        document.getElementById('boot-logs').innerText = "Link Failed: JSON Error";
    }
}

// 2. Initialize the UI after data is loaded
function initializeApp() {
    modelSelect.innerHTML = ''; 
    modelData.forEach((m, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = m.name;
        modelSelect.appendChild(opt);
    });
    updateAsset(0);
}

// 3. Update the viewer and metadata
function updateAsset(index) {
    const asset = modelData[index];
    
    // Update model sources
    viewer.src = `models/${asset.file}.glb`;
    viewer.setAttribute('ios-src', `models/${asset.file}.usdz`);
    
    // Update Metadata Panels
    document.getElementById('asset-title').textContent = asset.name;
    document.getElementById('spec-crew').textContent = asset.crew;
    document.getElementById('spec-base').textContent = asset.base;
    document.getElementById('spec-weapons').textContent = asset.weapons;
    document.getElementById('spec-weight').textContent = asset.weight;
    document.getElementById('spec-length').textContent = asset.length;
    document.getElementById('spec-payload').textContent = asset.payload;
    document.getElementById('spec-desc').textContent = asset.description;
}

// 4. UI Functions
function toggleDetails() {
    document.getElementById('details-panel').classList.toggle('active');
}

function enterApp() {
    const startScreen = document.getElementById('start-screen');
    startScreen.style.opacity = '0';
    setTimeout(() => startScreen.style.visibility = 'hidden', 800);
}

// Start Boot Sequence
const logs = ["Connecting...", "Syncing GSE Data...", "Mapping USDZ Telemetry...", "Active."];
let logIndex = 0;
function updateLogs() {
    if (logIndex < logs.length) {
        document.getElementById('boot-logs').innerText = logs[logIndex];
        logIndex++;
        setTimeout(updateLogs, 600);
    }
}

updateLogs();
loadModelData(); // Trigger the fetch

modelSelect.addEventListener('change', (e) => updateAsset(e.target.value));
